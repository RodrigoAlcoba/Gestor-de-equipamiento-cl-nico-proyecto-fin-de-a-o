CREATE TABLE USUARIOS(
    ID_Usuario INTEGER NOT NULL,
    ID_Institucion INTEGER,
    ID_Perfil INTEGER,
    Cedula VARCHAR(50) NOT NULL, 
    Nombre VARCHAR(50) NOT NULL, 
    Apellido VARCHAR(50) NOT NULL, 
    Fec_Nac DATE NOT NULL, 
    Email VARCHAR(50) NOT NULL, 
    Contrasenia VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Usuario PRIMARY KEY(ID_Usuario),
    CONSTRAINT UK_Usuario_CI UNIQUE(Cedula),
    CONSTRAINT UK_Usuario_Email UNIQUE(Email),
    CONSTRAINT FK_Usuario_Institucion FOREIGN KEY(ID_Institucion) REFERENCES INSTITUCIONES(ID_Institucion),
    CONSTRAINT FK_Usuario_Perfil FOREIGN KEY(ID_Perfil) REFERENCES PERFILES(ID_Perfil)
)TABLESPACE USERS;


ALTER TABLE PERFILES 
ADD CONSTRAINT chk_perfil_nombre  CHECK(UPPER(Nom_Perfil) IN(UPPER('Auxiliar Administrativo', 'Ingeniero
biomédico', 'Tecnólogo, Técnico')));

-- TABLAS RELACIONADAS AL USUARIO --

CREATE TABLE TELEFONOS(
    ID_Tel INTEGER NOT NULL, 
    ID_Usuario INTEGER,
    Telefono NUMBER NOT NULL, 
    CONSTRAINT PK_Tel PRIMARY KEY(ID_Tel),
    CONSTRAINT FK_Tel_Usuario FOREIGN KEY(ID_Usuario) REFERENCES USUARIOS(ID_Usuario)
)TABLESPACE USERS;

CREATE TABLE PERFILES(
    ID_Perfil INTEGER NOT NULL,
    ID_Permiso INTEGER,
    Nom_Perfil VARCHAR(50) NOT NULL, 
    Estado VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Perfil PRIMARY KEY(ID_Perfil),
    CONSTRAINT UK_Perfil_Nom UNIQUE(Nom_Perfil),
    CONSTRAINT FK_Perfil_Permiso FOREIGN KEY(ID_Permiso) REFERENCES PERMISOS(ID_Permiso)
)TABLESPACE USERS;

--CHECK 

CREATE TABLE PERMISOS(
    ID_Permiso INTEGER NOT NULL, 
    Tipo_Permiso VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Permiso PRIMARY KEY(ID_Permiso),
    CONSTRAINT UK_Permiso_Tipo UNIQUE(Tipo_Permiso)
)TABLESPACE USERS;

CREATE TABLE AUDITORIAS(
    ID_Usuario INTEGER,
    ID_Operacion INTEGER,
    Hora TIMESTAMP(0) NOT NULL,
    Fecha DATE NOT NULL, 
    CONSTRAINT PK_Auditoria PRIMARY KEY(ID_Usuario, ID_Operacion),
    CONSTRAINT FK_Auditoria_Usuario FOREIGN KEY(ID_Usuario) REFERENCES USUARIOS(ID_Usuario),
    CONSTRAINT FK_Auditoria_ FOREIGN KEY(ID_Auditoria) REFERENCES AUDITORIAS(ID_Auditoria)
)TABLESPACE USERS;

CREATE TABLE OPERACIONES(
    ID_Operacion INTEGER NOT NULL,
    Nom_Operacion VARCHAR(50) NOT NULL, 
    CONSTRAINT PK_Operacion PRIMARY KEY(ID_Operacion),
    CONSTRAINT UK_Operacion_Nom UNIQUE(Nom_Operacion)
)TABLESPACE USERS;

CREATE TABLE INTERVENCIONES(
    ID_Intervencion INTEGER NOT NULL,
    ID_Equipo INTEGER,
    ID_Usuario INTEGER,
    ID_Tipo_Intervencion INTEGER,
    Motivo VARCHAR(50), --dif 
    Comentario VARCHAR(200) NOT NULL,
    Fecha DATE NOT NULL, 
    Hora TIMESTAMP(0) NOT NULL, 
    CONSTRAINT PK_Intervencion PRIMARY KEY(ID_Intervencion),
    CONSTRAINT FK_Intervencion_Equipo FOREIGN KEY(ID_Equipo) REFERENCES EQUIPOS(ID_Equipo),
    CONSTRAINT FK_Intervencion_Usuario FOREIGN KEY(ID_Usuario) REFERENCES EQUIPOS(ID_Usuario),
    CONSTRAINT FK_Intervencin_Tipo FOREIGN KEY(ID_Tipo_Intervencion) REFERENCES TIPO_INTERVENCION(ID_Tipo_Intervencion)
)TABLESPACE USERS;

CREATE TABLE TIPO_INTERVENCION(
    ID_Tipo_Intervencion INTEGER NOT NULL, 
    Nom_Tipo VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Tipo_Intervencion PRIMARY KEY(ID_Tipo_Intervencion),
    CONSTRAINT UK_Tipo_Nom UNIQUE(Nom_Tipo)
)TABLESPACE USERS;

ALTER TABLE TIPO_INTERVENCION 
ADD CONSTRAINT chk_intervencion_tipo  CHECK(UPPER(Nom_Tipo) IN(UPPER('Prevencion', 'Falla', 'Resolucion'))); --sin tildes

---

CREATE TABLE INSTITUCIONES(
    ID_Institucion INTEGER NOT NULL, 
    ID_Ubiacion INTEGER,
    Nom_Institucion VARCHAR(80) NOT NULL, 
    CONSTRAINT PK_Institucion PRIMARY KEY(ID_Institucion),
    CONSTRAINT UK_Insti_Nom UNIQUE(Nom_Institucion),
    CONSTRAINT FK_Insti_Ubicacion FOREIGN KEY(ID_Ubiacion) REFERENCES UBICACIONES(ID_Ubicacion)
)TABLESPACE USERS;

CREATE TABLE UBICACIONES(
    Nom_Ubicacion VARCHAR(80) NOT NULL, 
    Sector VARCHAR(50) NOT NULL, 
    Numero NUMBER NOT NULL,
    Piso VARCHAR(50) NOT NULL, 
    Cama NUMBER,
    CONSTRAINT PK_Ubicacion PRIMARY KEY(ID_Ubicacion),
    CONSTRAINT UK_Ubicacion_Nom UNIQUE(Nom_Ubicacion),
    CONSTRAINT UK_Ubicacion_Sector UNIQUE(Sector)
)TABLESPACE USERS;

ALTER TABLE UBICACION
ADD CONSTRAINT chk_ubicacion_sector  CHECK(UPPER(Sector) IN(UPPER('Policlinico', 'Internacion', 'Emergencia', 'CTI',
'otro'))); --sin tildes

CREATE TABLE EQUIPOS(
    ID_Equipo INTEGER NOT NULL, 
    ID_Ubicacion INTEGER,
    ID_Pais INTEGER, 
    Tipo_Equipo INTEGER, 
    Proveedor INTEGER, 
    Modelo INTEGER, 
    Nom_Equipo VARCHAR(80) NOT NULL, 
    Num_Serie NUMBER NOT NULL, 
    Fec_Adquisicion DATE NOT NULL, 
    Imagen BLOB, 
    CONSTRAINT PK_Equipo PRIMARY KEY(ID_Equipo),
    CONSTRAINT FK_Equipo_Ubicacion FOREIGN KEY(ID_Ubicacion) REFERENCES UBICACIONES(ID_Ubicacion),
    CONSTRAINT FK_Equipo_Pais FOREIGN KEY(ID_Pais) REFERENCES PAISES(ID_Pais),
    CONSTRAINT FK_Equipo_Tipo FOREIGN KEY(ID_Tipo_Equipo) REFERENCES TIPO_EQUIPO(ID_Tipo_Equipo),
    CONSTRAINT FK_Equipo_Proveedor FOREIGN KEY(ID_Proveedor) REFERENCES PROVEEDORES(ID_Proveedor),
    CONSTRAINT FK_Equipo_Modelo FOREIGN KEY(ID_Modelo) REFERENCES MODELOS(ID_Modelo)
)TABLESPACE USERS;

CREATE TABLE PAISES(
    ID_Pais INTEGER NOT NULL,
    Nom_Pais VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Pais PRIMARY KEY(ID_Paises),
    CONSTRAINT UK_Pais_Nom UNIQUE(Nom_Pais)
)TABLESPACE USERS;

CREATE TABLE TIPO_EQUIPO(
    ID_Tipo_Equipo INTEGER NOT NULL,
    Nom_Tipo VARCHAR(50) NOT NULL,
    CONSTRAINT PK_Tipo_Equipo PRIMARY KEY(ID_Tipo_Equipo),
    CONSTRAINT UK_Tipo_Equipo_Nom UNIQUE(Nom_Tipo)
)TABLESPACE USERS;

CREATE TABLE PROVEEDORES(
    ID_Proveedor INTEGER NOT NULL, 
    Nom_Proveedor VARCHAR(80) NOT NULL, 
    CONSTRAINT PK_Proveedor PRIMARY KEY(ID_Proveedor),
    CONSTRAINT UK_Proveedor_Nom UNIQUE(Nom_Proveedor)
)TABLESPACE USERS;

CREATE TABLE MODELOS(
    ID_Modelos INTEGER NOT NULL, 
    ID_Marca INTEGER, 
    Nom_Modelo VARCHAR(50) NOT NULL, 
    CONSTRAINT PK_Modelo PRIMARY KEY(ID_Modelo),
    CONSTRAINT UK_Modelo_Nom UNIQUE(Nom_Modelo),
    CONSTRAINT FK_Modelo_Marca FOREIGN KEY(ID_Marca) REFERENCES MARCAS(ID_Marca)
)TABLESPACE USERS;

CREATE TABLE MARCAS(
    ID_Marca INTEGER NOT NULL, 
    Nom_Marca VARCHAR(50) NOT NULL, 
    CONSTRAINT PK_Marca PRIMARY KEY(ID_Marca), 
    CONSTRAINT UK_Marca_Nom UNIQUE(Nom_Marca)
)TABLESPACE USERS;

CREATE TABLE BAJA_USUARIO_EQUIPO(
    ID_Usuario INTEGER NOT NULL, 
    ID_Equipo INTEGER NOT NULL, 
    Fec_Baja DATE NOT NULL, 
    Razon VARCHAR(80) NOT NULL, 
    Comentario VARCHAR(200),
    CONSTRAINT PK_Baja_UE PRIMARY KEY(ID_Usuario, ID_Equipo), 
    CONSTRAINT FK_Baja_Usuario FOREIGN KEY(ID_Usuario) REFERENCES USUARIOS(ID_Usuario),
    CONSTRAINT FK_Baja_Equipo FOREIGN KEY(ID_Equipo) REFERENCES EQUIPOS(ID_Equipo)
)TABLESPACE USERS;

CREATE TABLE BAJA_USUARIO_UBICACION(
    ID_Usuario INTEGER NOT NULL, 
    ID_Ubicacion INTEGER NOT NULL, 
    Fecha DATE NOT NULL, 
    Razon VARCHAR(80) NOT NULL, 
    Comentario VARCHAR(200),
    CONSTRAINT PK_Baja_UE PRIMARY KEY(ID_Usuario, ID_Ubicacion),
    CONSTRAINT FK_Baja_Usuario FOREIGN KEY(ID_Usuario) REFERENCES USUARIOS(ID_Usuario),
    CONSTRAINT FK_Baja_Ubicacion FOREIGN KEY(ID_Ubicacion) REFERENCES UBICACIONES(ID_Ubicacion)
)TABLESPACE USERS;
